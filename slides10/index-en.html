<!DOCTYPE html><html lang="ru"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"><title>Core Java. Lecture #10: Java Concurrency</title><meta name="author" content="Ivan Ponomarev, Synthesized.io/MIPT"><link rel="stylesheet" href="reveal.js-3.9.2/css/reset.css"><link rel="stylesheet" href="reveal.js-3.9.2/css/reveal.css"><link rel="stylesheet" href="white_course.css" id="theme"><!--This CSS is generated by the Asciidoctor reveal.js converter to further integrate AsciiDoc's existing semantic with reveal.js--><style type="text/css">.reveal div.right {
  float: right
}

/* listing block */
.reveal .listingblock.stretch > .content {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre > code {
  height: 100%;
  max-height: 100%
}

/* tables */
table {
  border-collapse: collapse;
  border-spacing: 0
}

table {
  margin-bottom: 1.25em;
  border: solid 1px #dedede
}

table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td {
  padding: .5em .625em .625em;
  font-size: inherit;
  text-align: left
}

table tr th, table tr td {
  padding: .5625em .625em;
  font-size: inherit
}

table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td {
  display: table-cell;
  line-height: 1.6
}

td.tableblock > .content {
  margin-bottom: 1.25em
}

td.tableblock > .content > :last-child {
  margin-bottom: -1.25em
}

table.tableblock, th.tableblock, td.tableblock {
  border: 0 solid #dedede
}

table.grid-all > thead > tr > .tableblock, table.grid-all > tbody > tr > .tableblock {
  border-width: 0 1px 1px 0
}

table.grid-all > tfoot > tr > .tableblock {
  border-width: 1px 1px 0 0
}

table.grid-cols > * > tr > .tableblock {
  border-width: 0 1px 0 0
}

table.grid-rows > thead > tr > .tableblock, table.grid-rows > tbody > tr > .tableblock {
  border-width: 0 0 1px
}

table.grid-rows > tfoot > tr > .tableblock {
  border-width: 1px 0 0
}

table.grid-all > * > tr > .tableblock:last-child, table.grid-cols > * > tr > .tableblock:last-child {
  border-right-width: 0
}

table.grid-all > tbody > tr:last-child > .tableblock, table.grid-all > thead:last-child > tr > .tableblock, table.grid-rows > tbody > tr:last-child > .tableblock, table.grid-rows > thead:last-child > tr > .tableblock {
  border-bottom-width: 0
}

table.frame-all {
  border-width: 1px
}

table.frame-sides {
  border-width: 0 1px
}

table.frame-topbot, table.frame-ends {
  border-width: 1px 0
}

.reveal table th.halign-left, .reveal table td.halign-left {
  text-align: left
}

.reveal table th.halign-right, .reveal table td.halign-right {
  text-align: right
}

.reveal table th.halign-center, .reveal table td.halign-center {
  text-align: center
}

.reveal table th.valign-top, .reveal table td.valign-top {
  vertical-align: top
}

.reveal table th.valign-bottom, .reveal table td.valign-bottom {
  vertical-align: bottom
}

.reveal table th.valign-middle, .reveal table td.valign-middle {
  vertical-align: middle
}

table thead th, table tfoot th {
  font-weight: bold
}

tbody tr th {
  display: table-cell;
  line-height: 1.6
}

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p {
  font-weight: bold
}

thead {
  display: table-header-group
}

.reveal table.grid-none th, .reveal table.grid-none td {
  border-bottom: 0 !important
}

/* kbd macro */
kbd {
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  display: inline-block;
  color: rgba(0, 0, 0, .8);
  font-size: .65em;
  line-height: 1.45;
  background: #f7f7f7;
  border: 1px solid #ccc;
  -webkit-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em white inset;
  box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em #fff inset;
  margin: 0 .15em;
  padding: .2em .5em;
  vertical-align: middle;
  position: relative;
  top: -.1em;
  white-space: nowrap
}

.keyseq kbd:first-child {
  margin-left: 0
}

.keyseq kbd:last-child {
  margin-right: 0
}

/* callouts */
.conum[data-value] {
  display: inline-block;
  color: #fff !important;
  background: rgba(0, 0, 0, .8);
  -webkit-border-radius: 50%;
  border-radius: 50%;
  text-align: center;
  font-size: .75em;
  width: 1.67em;
  height: 1.67em;
  line-height: 1.67em;
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-style: normal;
  font-weight: bold
}

.conum[data-value] * {
  color: #fff !important
}

.conum[data-value] + b {
  display: none
}

.conum[data-value]:after {
  content: attr(data-value)
}

pre .conum[data-value] {
  position: relative;
  top: -.125em
}

b.conum * {
  color: inherit !important
}

.conum:not([data-value]):empty {
  display: none
}

/* Callout list */
.hdlist > table, .colist > table {
  border: 0;
  background: none
}

.hdlist > table > tbody > tr, .colist > table > tbody > tr {
  background: none
}

td.hdlist1, td.hdlist2 {
  vertical-align: top;
  padding: 0 .625em
}

td.hdlist1 {
  font-weight: bold;
  padding-bottom: 1.25em
}

/* Disabled from Asciidoctor CSS because it caused callout list to go under the
 * source listing when .stretch is applied (see #335)
 * .literalblock+.colist,.listingblock+.colist{margin-top:-.5em} */
.colist td:not([class]):first-child {
  padding: .4em .75em 0;
  line-height: 1;
  vertical-align: top
}

.colist td:not([class]):first-child img {
  max-width: none
}

.colist td:not([class]):last-child {
  padding: .25em 0
}

/* Override Asciidoctor CSS that causes issues with reveal.js features */
.reveal .hljs table {
  border: 0
}

/* Callout list rows would have a bottom border with some reveal.js themes (see #335) */
.reveal .colist > table th, .reveal .colist > table td {
  border-bottom: 0
}

/* Fixes line height with Highlight.js source listing when linenums enabled (see #331) */
.reveal .hljs table thead tr th, .reveal .hljs table tfoot tr th, .reveal .hljs table tbody tr td, .reveal .hljs table tr td, .reveal .hljs table tfoot tr td {
  line-height: inherit
}

/* Columns layout */
.columns .slide-content {
  display: flex;
}

.columns.wrap .slide-content {
  flex-wrap: wrap;
}

.columns.is-vcentered .slide-content {
  align-items: center;
}

.columns .slide-content > .column {
  display: block;
  flex-basis: 0;
  flex-grow: 1;
  flex-shrink: 1;
}

.columns .slide-content > .column > * {
  padding: .75rem;
}

/* See #353 */
.columns.wrap .slide-content > .column {
  flex-basis: auto;
}

.columns .slide-content > .column.is-full {
  flex: none;
  width: 100%;
}

.columns .slide-content > .column.is-four-fifths {
  flex: none;
  width: 80%;
}

.columns .slide-content > .column.is-three-quarters {
  flex: none;
  width: 75%;
}

.columns .slide-content > .column.is-two-thirds {
  flex: none;
  width: 66.6666%;
}

.columns .slide-content > .column.is-three-fifths {
  flex: none;
  width: 60%;
}

.columns .slide-content > .column.is-half {
  flex: none;
  width: 50%;
}

.columns .slide-content > .column.is-two-fifths {
  flex: none;
  width: 40%;
}

.columns .slide-content > .column.is-one-third {
  flex: none;
  width: 33.3333%;
}

.columns .slide-content > .column.is-one-quarter {
  flex: none;
  width: 25%;
}

.columns .slide-content > .column.is-one-fifth {
  flex: none;
  width: 20%;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.text-left {
  text-align: left !important
}

.text-right {
  text-align: right !important
}

.text-center {
  text-align: center !important
}

.text-justify {
  text-align: justify !important
}

.footnotes {
  border-top: 1px solid rgba(0, 0, 0, 0.2);
  padding: 0.5em 0 0 0;
  font-size: 0.65em;
  margin-top: 4em;
}
</style><link rel="stylesheet" href="./font-awesome-4.7.0/css/font-awesome.css"><script type="text/x-mathjax-config">MathJax.Hub.Config({
tex2jax: {
  inlineMath: [["\\(", "\\)"]],
  displayMath: [["\\[", "\\]"]],
  ignoreClass: "nostem|nolatexmath"
},
asciimath2jax: {
  delimiters: [["\\$", "\\$"]],
  ignoreClass: "nostem|noasciimath"
},
TeX: { equationNumbers: { autoNumber: "none" } }
});</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script><!--Printing and PDF exports--><script>var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? "reveal.js-3.9.2/css/print/pdf.css" : "reveal.js-3.9.2/css/print/paper.css";
document.getElementsByTagName( 'head' )[0].appendChild( link );</script></head><body><div class="reveal"><div class="slides"><section class="title" data-state="title"><h1>Core Java. Lecture #10</h1><h2>Java Concurrency</h2><div class="preamble"><div class="paragraph"><p><a href="mailto:ponomarev@corchestra.ru">ponomarev@corchestra.ru</a></p></div>
<div class="paragraph"><p><span class="icon"><i class="fa fa-twitter fa-lg"></i></span> @inponomarev</p></div></div><p class="author"><small>Ivan Ponomarev, Synthesized.io/MIPT</small></p></section>
<section id="_concurrent_execution"><h2>Concurrent execution</h2><div class="slide-content"><div class="ulist"><ul><li><p>One program&#8201;&#8212;&#8201;many simultaneous threads</p></li><li><p>Why do we need Concurrency at all?</p></li></ul></div>
<div class="paragraph fragment"><p>&#8201;&#8212;&#8201;For performance, to make things quickly!</p></div></div></section>
<section id="_where_can_we_benefit_from_concurrency"><h2>Where can we benefit from concurrency?</h2><div class="slide-content"><div class="ulist"><ul><li><p>Many CPU cores, the computational task is divided into subtasks well.</p></li><li><p>Subtasks are blocked on I/O, you can wait for multiple replies in parallel or do something useful.</p></li><li><p>You need to respond to the request quickly and give a detailed answer later (user interface).</p></li><li><p>Multi-user service (each request runs in its own thread).</p></li></ul></div></div></section>
<section id="_where_can_we_not_benefit_from_increasing_concurrency"><h2>Where can we NOT benefit from [increasing] concurrency?</h2><div class="slide-content"><div class="ulist"><ul><li><p>CPU-bound task will not be solved faster if there are more threads than cores.</p></li><li><p>The task is poorly parallelized (limited by a non-divisible resource).</p></li><li><p>We are limited by Amdahl law.</p></li></ul></div></div></section>
<section id="_amdahls_law"><h2>Amdahl&#8217;s law</h2><div class="slide-content"><div class="ulist"><ul><li><p>&alpha; is the proportion of calculations that must be performed sequentially,</p></li><li><p><em>N</em>&#8201;&#8212;&#8201;number of simultaneously executed threads,</p></li><li><p><em>S</em>&#8201;&#8212;&#8201;the resulting speedup.</p></li></ul></div>
<div class="stemblock"><div class="content">\[\Huge
S = \frac{1}{\alpha+\frac{1-\alpha}{N}} = \frac{N}{1+\alpha(N-1)} \leq \frac{1}{\alpha}\]</div></div>
<div class="paragraph"><p>Bottom line: If the shared work is 80%, you won&#8217;t get more than a fivefold increase in performance due to parallelization.</p></div></div></section>
<section id="_amdahls_law_2"><h2>Amdahl&#8217;s Law</h2><div class="slide-content"><div class="imageblock"><img src="images/amdahl.png" alt="amdahl" width="70%"></div></div></section>
<section id="_in_fact_its_even_worse"><h2>In fact, it&#8217;s even worse!</h2><div class="slide-content"><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:25%"><col style="width:25%"><col style="width:25%"><col style="width:25%"></colgroup><tbody><tr><td class="tableblock halign-center valign-middle"><div><div class="stemblock"><div class="content">\[\Large
N = 4, E = 6\]</div></div></div></td><td class="tableblock halign-center valign-middle"><div><div class="stemblock"><div class="content">\[\Large
N = 5, E = 10\]</div></div></div></td><td class="tableblock halign-center valign-middle"><div><div class="stemblock"><div class="content">\[\Large
N = 6, E = 15\]</div></div></div></td><td class="tableblock halign-center valign-middle"><div><div class="stemblock"><div class="content">\[\Large
N = 7, E = 21\]</div></div></div></td></tr><tr><td class="tableblock halign-center valign-middle"><div><div class="imageblock"><img src="images/k4.png.png" alt="k4"></div></div></td><td class="tableblock halign-center valign-middle"><div><div class="imageblock"><img src="images/k5.png.png" alt="k5"></div></div></td><td class="tableblock halign-center valign-middle"><div><div class="imageblock"><img src="images/k6.png.png" alt="k6"></div></div></td><td class="tableblock halign-center valign-middle"><div><div class="imageblock"><img src="images/k7.png.png" alt="k7"></div></div></td></tr></table>
<div class="stemblock"><div class="content">\[\Huge
E = \frac{N (N -1)}{2}\]</div></div></div></section>
<section id="_in_fact_its_even_worse_2"><h2>In fact, it&#8217;s even worse!</h2><div class="slide-content"><div class="ulist"><ul><li><p>Uiversal Scalability Law, a semi-empirical generalization of Amdahl&#8217;s law</p><div class="ulist"><ul><li><p>&beta; is a parameter that defines cohesion (inter-thread coordination)</p></li><li><p>fits well on empirical data</p></li></ul></div></li></ul></div>
<div class="stemblock"><div class="content">\[\Large
S = \frac{N}{1+\alpha(N-1) + \beta N (N-1)} = \frac{N}{1+(\alpha + \beta N) (N-1)}\]</div></div></div></section>
<section id="_usl_plot"><h2>USL plot</h2><div class="slide-content"><div class="imageblock"><img src="images/usl.png" alt="usl" width="70%"></div></div></section>
<section id="_intermediate_conclusions"><h2>Intermediate conclusions</h2><div class="slide-content"><div class="ulist"><ul><li><p>Before embarking on the slippery slope of multithreaded programming, consider:</p><div class="ulist"><ul><li><p>Is this necessary to solve the problem?</p></li><li><p>How many threads do you need?</p></li></ul></div></li><li><p>You have been warned.</p></li></ul></div>
<div class="imageblock"><img src="images/hydra1.jpg" alt="hydra1" width="40%"></div></div></section>
<section id="_part_1_why_do_you_need_synchronization_and_how_is_it_achieved"><h2>Part 1. Why do you need synchronization and how is it achieved</h2><div class="slide-content"><div class="imageblock"><img src="images/hydra2.jpg" alt="hydra2" width="90%"></div></div></section>
<section id="first_example"><h2>Multithreading in Java (from the very first version!)</h2><div class="slide-content"><div class="imageblock"><img src="images/runthr.png" alt="runthr"></div>
<div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #000000;font-weight: bold">class</span> <span style="color: #445588;font-weight: bold">CalcSquare</span> <span style="color: #000000;font-weight: bold">extends</span> <span style="color: #445588;font-weight: bold">Thread</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="color: #000000;font-weight: bold">final</span> <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">argument</span><span style="color: #000000;font-weight: bold">;</span>
    <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">result</span><span style="color: #000000;font-weight: bold">;</span>
    <span style="color: #445588;font-weight: bold">CalcSquare</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">argument</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
        <span style="color: #000000;font-weight: bold">this</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">argument</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">argument</span><span style="color: #000000;font-weight: bold">;</span>
    <span style="color: #000000;font-weight: bold">}</span>
    <span style="color: #3c5d5d;font-weight: bold">@Override</span>
    <span style="color: #000000;font-weight: bold">public</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">run</span><span style="color: #000000;font-weight: bold">()</span> <span style="color: #000000;font-weight: bold">{</span>
        <span style="color: #999988;font-style: italic">//"complex" calculations</span>
        <span style="background-color: #f8f8f8">result</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">argument</span> <span style="color: #000000;font-weight: bold">*</span> <span style="background-color: #f8f8f8">argument</span><span style="color: #000000;font-weight: bold">;</span>
    <span style="color: #000000;font-weight: bold">}</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre></div></div></div></section>
<section id="_run_parallel_computing_via_thread_api"><h2>Run parallel computing via Thread API</h2><div class="slide-content"><div class="ulist"><ul><li><p>NB: in real world you will not use the Thread API</p></li></ul></div>
<div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #445588;font-weight: bold">CalcSquare</span> <span style="background-color: #f8f8f8">t1</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">CalcSquare</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #009999">2</span><span style="color: #000000;font-weight: bold">);</span>
<span style="color: #445588;font-weight: bold">CalcSquare</span> <span style="background-color: #f8f8f8">t2</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">CalcSquare</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #009999">3</span><span style="color: #000000;font-weight: bold">);</span>
<span style="background-color: #f8f8f8">t1</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">start</span><span style="color: #000000;font-weight: bold">();</span>
<span style="background-color: #f8f8f8">t2</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">start</span><span style="color: #000000;font-weight: bold">();</span>
<span style="background-color: #f8f8f8">t1</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">join</span><span style="color: #000000;font-weight: bold">();</span>
<span style="background-color: #f8f8f8">t2</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">join</span><span style="color: #000000;font-weight: bold">();</span>
<span style="color: #445588;font-weight: bold">System</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">out</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">printf</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"%d, %d%n"</span><span style="color: #000000;font-weight: bold">,</span> <span style="background-color: #f8f8f8">t1</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">result</span><span style="color: #000000;font-weight: bold">,</span> <span style="background-color: #f8f8f8">t2</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">result</span><span style="color: #000000;font-weight: bold">);</span>
<span style="color: #999988;font-style: italic">//otput: 4, 9</span></code></pre></div></div></div></section>
<section id="_problems_with_shared_state"><h2>Problems with shared state</h2><div class="slide-content"><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="imageblock"><img src="images/hydraheads.jpg" alt="hydraheads"></div></div></td><td class="tableblock halign-left valign-middle"><div><div class="ulist"><ul><li><p>Race condition</p></li><li><p>Stale values</p></li><li><p>Reordering</p></li></ul></div></div></td></tr></table></div></section>
<section id="_race_condition"><h2>Race condition</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #000000;font-weight: bold">class</span> <span style="color: #445588;font-weight: bold">DumbCounter</span> <span style="color: #000000;font-weight: bold">{</span>
  <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">count</span><span style="color: #000000;font-weight: bold">;</span>
  <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">increment</span><span style="color: #000000;font-weight: bold">(){</span>
    <span style="background-color: #f8f8f8">count</span><span style="color: #000000;font-weight: bold">++;</span>
  <span style="color: #000000;font-weight: bold">}</span>
<span style="color: #000000;font-weight: bold">}</span>

<span style="color: #445588;font-weight: bold">DumbCounter</span> <span style="background-color: #f8f8f8">c1</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">DumbCounter</span><span style="color: #000000;font-weight: bold">();</span>
<span style="color: #445588;font-weight: bold">IntStream</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">range</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #009999">0</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #009999">1000000</span><span style="color: #000000;font-weight: bold">).</span><span style="color: #008080">forEach</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">i</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">c1</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">increment</span><span style="color: #000000;font-weight: bold">());</span>

<span style="color: #445588;font-weight: bold">DumbCounter</span> <span style="background-color: #f8f8f8">c2</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">DumbCounter</span><span style="color: #000000;font-weight: bold">();</span>
<span style="color: #445588;font-weight: bold">IntStream</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">range</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #009999">0</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #009999">1000000</span><span style="color: #000000;font-weight: bold">).</span><span style="color: #008080">parallel</span><span style="color: #000000;font-weight: bold">().</span><span style="color: #008080">forEach</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">i</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">c2</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">increment</span><span style="color: #000000;font-weight: bold">());</span>

<span style="color: #445588;font-weight: bold">System</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">out</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">printf</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"%d, %d%n"</span><span style="color: #000000;font-weight: bold">,</span> <span style="background-color: #f8f8f8">c1</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">count</span><span style="color: #000000;font-weight: bold">,</span> <span style="background-color: #f8f8f8">c2</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">count</span><span style="color: #000000;font-weight: bold">);</span>

<span style="color: #999988;font-style: italic">//1000000,??????</span></code></pre></div></div></div></section>
<section id="_stale_values"><h2>Stale values</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #000000;font-weight: bold">class</span> <span style="color: #445588;font-weight: bold">DumbWayToFallAsleep</span> <span style="color: #000000;font-weight: bold">implements</span> <span style="color: #445588;font-weight: bold">Runnable</span> <span style="color: #000000;font-weight: bold">{</span>
  <span style="color: #000000;font-weight: bold">private</span> <span style="color: #445588;font-weight: bold">boolean</span> <span style="background-color: #f8f8f8">asleep</span><span style="color: #000000;font-weight: bold">;</span>

  <span style="color: #000000;font-weight: bold">public</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">setAsleep</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">boolean</span> <span style="background-color: #f8f8f8">asleep</span><span style="color: #000000;font-weight: bold">){</span>
    <span style="color: #000000;font-weight: bold">this</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">asleep</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">asleep</span><span style="color: #000000;font-weight: bold">;</span>
  <span style="color: #000000;font-weight: bold">}</span>

  <span style="color: #3c5d5d;font-weight: bold">@Override</span>
  <span style="color: #000000;font-weight: bold">public</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">run</span><span style="color: #000000;font-weight: bold">()</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="color: #000000;font-weight: bold">while</span> <span style="color: #000000;font-weight: bold">(!</span><span style="background-color: #f8f8f8">asleep</span><span style="color: #000000;font-weight: bold">){</span>
      <span style="color: #999988;font-style: italic">//countSomeSheep</span>
      <span style="color: #999988;font-style: italic">//WILL WE FALL ASLEEP?</span>
    <span style="color: #000000;font-weight: bold">}</span>
  <span style="color: #000000;font-weight: bold">}</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre></div></div></div></section>
<section id="_reordering"><h2>Reordering</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #000000;font-weight: bold">class</span> <span style="color: #445588;font-weight: bold">PossibleReordering</span> <span style="color: #000000;font-weight: bold">{</span>
  <span style="color: #000000;font-weight: bold">static</span> <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">x</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">0</span><span style="color: #000000;font-weight: bold">,</span> <span style="background-color: #f8f8f8">y</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">0</span><span style="color: #000000;font-weight: bold">,</span> <span style="background-color: #f8f8f8">a</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">0</span><span style="color: #000000;font-weight: bold">,</span> <span style="background-color: #f8f8f8">b</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">0</span><span style="color: #000000;font-weight: bold">;</span>
  <span style="color: #000000;font-weight: bold">public</span> <span style="color: #000000;font-weight: bold">static</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">main</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">String</span><span style="color: #000000;font-weight: bold">...</span> <span style="background-color: #f8f8f8">args</span><span style="color: #000000;font-weight: bold">)</span>
                <span style="color: #000000;font-weight: bold">throws</span> <span style="color: #445588;font-weight: bold">InterruptedException</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="color: #999988;font-style: italic">//another method of starting a thread (you won't use it as well)</span>
    <span style="color: #445588;font-weight: bold">Thread</span> <span style="background-color: #f8f8f8">one</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">Thread</span><span style="color: #000000;font-weight: bold">(()</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
        <span style="background-color: #f8f8f8">a</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">1</span><span style="color: #000000;font-weight: bold">;</span> <span style="background-color: #f8f8f8">x</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">b</span><span style="color: #000000;font-weight: bold">;</span>
    <span style="color: #000000;font-weight: bold">});</span>
    <span style="color: #445588;font-weight: bold">Thread</span> <span style="background-color: #f8f8f8">two</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">Thread</span><span style="color: #000000;font-weight: bold">(()</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
        <span style="background-color: #f8f8f8">b</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">1</span><span style="color: #000000;font-weight: bold">;</span> <span style="background-color: #f8f8f8">y</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">a</span><span style="color: #000000;font-weight: bold">;</span>
    <span style="color: #000000;font-weight: bold">});</span>
    <span style="background-color: #f8f8f8">one</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">start</span><span style="color: #000000;font-weight: bold">();</span> <span style="background-color: #f8f8f8">two</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">start</span><span style="color: #000000;font-weight: bold">();</span>
    <span style="background-color: #f8f8f8">one</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">join</span><span style="color: #000000;font-weight: bold">();</span>  <span style="background-color: #f8f8f8">two</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">join</span><span style="color: #000000;font-weight: bold">();</span>
    <span style="color: #445588;font-weight: bold">System</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">out</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">printf</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"%d,%d"</span><span style="color: #000000;font-weight: bold">,</span> <span style="background-color: #f8f8f8">x</span><span style="color: #000000;font-weight: bold">,</span> <span style="background-color: #f8f8f8">y</span><span style="color: #000000;font-weight: bold">);</span>
    <span style="color: #999988;font-style: italic">//??,??</span>
  <span style="color: #000000;font-weight: bold">}</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre></div></div></div></section>
<section id="_thread_one_thread_two"><h2>Thread one, Thread two</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #445588;font-weight: bold">Thread</span> <span style="background-color: #f8f8f8">one</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">Thread</span><span style="color: #000000;font-weight: bold">(()</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="background-color: #f8f8f8">a</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">1</span><span style="color: #000000;font-weight: bold">;</span> <span style="background-color: #f8f8f8">x</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">b</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">});</span>
<span style="color: #445588;font-weight: bold">Thread</span> <span style="background-color: #f8f8f8">two</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">Thread</span><span style="color: #000000;font-weight: bold">(()</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="background-color: #f8f8f8">b</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">1</span><span style="color: #000000;font-weight: bold">;</span> <span style="background-color: #f8f8f8">y</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">a</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">});</span></code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code>         x  y  a  b

a = 1;   0  0  1  0
x = b;   0  0  1  0
b = 1;   0  0  1  1
y = a;   0  1  0  0</code></pre></div></div></div></section>
<section id="_thread_two_thread_one"><h2>Thread two, Thread one</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #445588;font-weight: bold">Thread</span> <span style="background-color: #f8f8f8">one</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">Thread</span><span style="color: #000000;font-weight: bold">(()</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="background-color: #f8f8f8">a</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">1</span><span style="color: #000000;font-weight: bold">;</span> <span style="background-color: #f8f8f8">x</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">b</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">});</span>
<span style="color: #445588;font-weight: bold">Thread</span> <span style="background-color: #f8f8f8">two</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">Thread</span><span style="color: #000000;font-weight: bold">(()</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="background-color: #f8f8f8">b</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">1</span><span style="color: #000000;font-weight: bold">;</span> <span style="background-color: #f8f8f8">y</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">a</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">});</span></code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code>         x  y  a  b

b = 1;   0  0  0  1
y = a;   0  0  0  1
a = 1;   0  0  1  1
x = b;   1  0  1  1</code></pre></div></div></div></section>
<section id="_threads_interleaved"><h2>Threads interleaved</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #445588;font-weight: bold">Thread</span> <span style="background-color: #f8f8f8">one</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">Thread</span><span style="color: #000000;font-weight: bold">(()</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="background-color: #f8f8f8">a</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">1</span><span style="color: #000000;font-weight: bold">;</span> <span style="background-color: #f8f8f8">x</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">b</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">});</span>
<span style="color: #445588;font-weight: bold">Thread</span> <span style="background-color: #f8f8f8">two</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">Thread</span><span style="color: #000000;font-weight: bold">(()</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="background-color: #f8f8f8">b</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">1</span><span style="color: #000000;font-weight: bold">;</span> <span style="background-color: #f8f8f8">y</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">a</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">});</span></code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code>         x  y  a  b

a = 1;   0  0  1  0
b = 1;   0  0  1  1
x = b;   1  0  1  1
y = a;   1  1  1  1
or
y = a;   0  1  1  1
x = b;   1  1  1  1</code></pre></div></div></div></section>
<section id="_intermediate_conclusions_2"><h2>Intermediate conclusions</h2><div class="slide-content"><div class="ulist"><ul><li><p>Due to reordering and other low-level features, it is <em>impossible</em> to reason about the result of one thread from the point of view of another thread as an intermediate result of the execution of the source code.</p></li><li><p>All problems with parallel computing are related to shared state.</p></li><li><p>The problems shown here are nondeterministic.</p></li><li><p>Any program with shared state access without proper synchronization is <em>broken</em>, even if "yesterday it worked on my machine".</p></li></ul></div></div></section>
<section id="_memory_model"><h2>Memory model</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">aVariable</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">42</span><span style="color: #000000;font-weight: bold">;</span></code></pre></div></div>
<div class="ulist"><ul><li><p>Java Memory Model (JMM)&#8201;&#8212;&#8201;A language and virtual machine specification that answers the question, "Under what conditions will a thread reading the 'aVariable' see a value of 42?"</p></li></ul></div></div></section>
<section id="_happens_before"><h2>Happens-before</h2><div class="slide-content"><div class="ulist"><ul><li><p>JMM defines a partial order on all actions in a Java program, called <em>happens before</em>.</p></li><li><p>The <em>happens-before</em> relation is transitive: \(A \prec B \wedge B \prec C \Rightarrow A \prec C\)</p></li><li><p>For action B to be guaranteed to see the result of action A, it is sufficient that \(A \prec B\).</p></li></ul></div></div></section>
<section id="_program_order_rule"><h2>Program order rule</h2><div class="slide-content"><div class="ulist"><ul><li><p>Within one thread, all actions <em>happens before</em> in the order of their definition in the source code of the program.</p></li><li><p>In other words, single-threaded programs are executed without surprises.</p></li></ul></div></div></section>
<section id="_thread_start_thread_termination_rule"><h2>Thread start &amp; thread termination rule</h2><div class="slide-content"><div class="ulist"><ul><li><p>Calling <code>threadA.start()</code> <em>happens-before</em> all operations on the <code>threadA</code>.</p></li><li><p>Any operation on the <code>threadA</code> <em>happens-before</em> the detection of the completion of <code>threadA</code> by another thread, either by exiting <code>threadA.join()</code> or by checking <code>threadA.isAlive() == false</code>.</p></li><li><p>Due to this rule, <a href="#first_example">our very first example</a> works correctly.</p></li></ul></div></div></section>
<section id="_volatile_keyword"><h2><code>volatile</code> keyword</h2><div class="slide-content"><div class="ulist"><ul><li><p>Class variables can be defined with the <code>volatile</code> keyword.</p></li><li><p><strong>Writing to a <code>volatile</code> variable <em>happens-before</em> reading from this variable on another thread.</strong></p></li><li><p>This automatically makes changes in all the other variables visible. Relying on this is not recommended: it works, but it makes the code fragile. In the process of refactoring, you can change the order of access to variables and thereby accidentally break the program.</p></li></ul></div></div></section>
<section id="_fix_stale_value_using_volatile"><h2>Fix stale value using volatile</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #000000;font-weight: bold">class</span> <span style="color: #445588;font-weight: bold">NotSoDumbWayToFallAsleep</span> <span style="color: #000000;font-weight: bold">implements</span> <span style="color: #445588;font-weight: bold">Runnable</span> <span style="color: #000000;font-weight: bold">{</span>
  <span style="color: #000000;font-weight: bold">private</span> <span style="color: #000000;font-weight: bold">volatile</span> <span style="color: #445588;font-weight: bold">boolean</span> <span style="background-color: #f8f8f8">asleep</span><span style="color: #000000;font-weight: bold">;</span>

  <span style="color: #000000;font-weight: bold">public</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">setAsleep</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">boolean</span> <span style="background-color: #f8f8f8">asleep</span><span style="color: #000000;font-weight: bold">){</span>
    <span style="color: #000000;font-weight: bold">this</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">asleep</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">asleep</span><span style="color: #000000;font-weight: bold">;</span>
  <span style="color: #000000;font-weight: bold">}</span>

  <span style="color: #3c5d5d;font-weight: bold">@Override</span>
  <span style="color: #000000;font-weight: bold">public</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">run</span><span style="color: #000000;font-weight: bold">()</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="color: #000000;font-weight: bold">while</span> <span style="color: #000000;font-weight: bold">(!</span><span style="background-color: #f8f8f8">asleep</span><span style="color: #000000;font-weight: bold">){</span>
      <span style="color: #999988;font-style: italic">//countSomeSheep</span>
      <span style="color: #999988;font-style: italic">//...</span>
    <span style="color: #000000;font-weight: bold">}</span>
  <span style="color: #000000;font-weight: bold">}</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre></div></div></div></section>
<section id="_final_fields"><h2><code>final</code> fields</h2><div class="slide-content"><div class="ulist"><ul><li><p>If the object is correctly published, i.e. if <em>reference to <code>this</code> does not leak from constructor</em>&#8201;&#8212;&#8201;<code>final</code> fields of the object are available to all the threads without synchronization.</p></li><li><p>The best way to deal with mutable state problems is to use immutable state wherever possible.</p></li></ul></div></div></section>
<section id="_non_atomic_operations_final_is_not_good_volatile_will_not_save_us"><h2>Non-atomic operations: final is not good, volatile will not save us</h2><div class="slide-content"><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #000000;font-weight: bold">class</span> <span style="color: #445588;font-weight: bold">DumbCounter</span> <span style="color: #000000;font-weight: bold">{</span>
  <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">count</span><span style="color: #000000;font-weight: bold">;</span>
  <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">increment</span><span style="color: #000000;font-weight: bold">(){</span>
    <span style="background-color: #f8f8f8">count</span><span style="color: #000000;font-weight: bold">++;</span>
  <span style="color: #000000;font-weight: bold">}</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre></div></div>
<div class="paragraph"><p>(We can declare <code>count</code> as <code>volatile</code>, but this won&#8217;t help.)</p></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">dumbMoneyTransfer</span><span style="color: #000000;font-weight: bold">(</span>
  <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">from</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">to</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">){</span>

    <span style="background-color: #f8f8f8">accounts</span><span style="color: #000000;font-weight: bold">[</span><span style="background-color: #f8f8f8">from</span><span style="color: #000000;font-weight: bold">]-=</span><span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">;</span>
    <span style="background-color: #f8f8f8">accounts</span><span style="color: #000000;font-weight: bold">[</span><span style="background-color: #f8f8f8">to</span><span style="color: #000000;font-weight: bold">]+=</span><span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre></div></div>
<div class="paragraph"><p>(By the way, a <code>volatile</code> array is not an array of <code>volatile</code> elements, and in Java you can&#8217;t just create an array of <code>volatile</code> elements that easy.)</p></div></div></td></tr></table></div></section>
<section id="_unsynchronized_execution"><h2>Unsynchronized execution</h2><div class="slide-content"><div class="imageblock"><img src="images/nonsync.png" alt="nonsync"></div></div></section>
<section id="_synchronized_execution"><h2>Synchronized execution</h2><div class="slide-content"><div class="imageblock"><img src="images/sync.png" alt="sync"></div></div></section>
<section id="_locks"><h2>Locks</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #999988;font-style: italic">//Reentrant is so called because</span>
<span style="color: #999988;font-style: italic">//the same thread is allowed to enter again</span>
<span style="color: #000000;font-weight: bold">private</span> <span style="color: #445588;font-weight: bold">ReentrantLock</span> <span style="background-color: #f8f8f8">bankLock</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">ReentrantLock</span><span style="color: #000000;font-weight: bold">();</span>

<span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">moneyTransfer</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">from</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">to</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
  <span style="background-color: #f8f8f8">bankLock</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">lock</span><span style="color: #000000;font-weight: bold">();</span>
  <span style="color: #000000;font-weight: bold">try</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="background-color: #f8f8f8">accounts</span><span style="color: #000000;font-weight: bold">[</span><span style="background-color: #f8f8f8">from</span><span style="color: #000000;font-weight: bold">]-=</span><span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">;</span>
    <span style="background-color: #f8f8f8">accounts</span><span style="color: #000000;font-weight: bold">[</span><span style="background-color: #f8f8f8">to</span><span style="color: #000000;font-weight: bold">]+=</span><span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">;</span>
  <span style="color: #000000;font-weight: bold">}</span> <span style="color: #000000;font-weight: bold">finally</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="background-color: #f8f8f8">bankLock</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">unlock</span><span style="color: #000000;font-weight: bold">();</span>
  <span style="color: #000000;font-weight: bold">}</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre></div></div>
<div class="paragraph fragment"><p>Did you asked yourself: where is the guarantee that after the exit from blocking, the thread will see the result of the work of the previous thread? If you did, then you had begun to understand something.</p></div></div></section>
<section id="_jmm_monitor_lock_rule"><h2>JMM Monitor Lock Rule</h2><div class="slide-content"><div class="ulist"><ul><li><p>Unlocking <em>happens before</em> another locking of the same lock.</p></li><li><p>Therefore, lock-protected variables should no longer be declared as <code>volatile</code>.</p></li></ul></div></div></section>
<section id="_whats_the_problem_here"><h2>What&#8217;s the problem here?</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #000000;font-weight: bold">while</span> <span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">accounts</span><span style="color: #000000;font-weight: bold">[</span><span style="background-color: #f8f8f8">from</span><span style="color: #000000;font-weight: bold">]</span> <span style="color: #000000;font-weight: bold">&lt;</span> <span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="color: #999988;font-style: italic">//wait ....</span>
<span style="color: #000000;font-weight: bold">}</span>

<span style="background-color: #f8f8f8">bankLock</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">lock</span><span style="color: #000000;font-weight: bold">();</span>
<span style="color: #000000;font-weight: bold">try</span> <span style="color: #000000;font-weight: bold">{</span>
  <span style="background-color: #f8f8f8">transfer</span> <span style="background-color: #f8f8f8">funds</span> <span style="color: #000000;font-weight: bold">...</span>
<span style="color: #000000;font-weight: bold">}</span> <span style="color: #000000;font-weight: bold">finally</span> <span style="color: #000000;font-weight: bold">{</span>
  <span style="background-color: #f8f8f8">bankLock</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">unlock</span><span style="color: #000000;font-weight: bold">();</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre></div></div>
<div class="paragraph fragment"><p>Access to <code>accounts[from]</code> is not synchronized, but even if it were synchronized, someone would be able to reduce the amount of money before entering the transfer funds block.</p></div></div></section>
<section id="_whats_the_problem_here_2"><h2>What&#8217;s the problem here?</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="background-color: #f8f8f8">bankLock</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">lock</span><span style="color: #000000;font-weight: bold">();</span>
<span style="color: #000000;font-weight: bold">try</span> <span style="color: #000000;font-weight: bold">{</span>
  <span style="color: #000000;font-weight: bold">while</span> <span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">accounts</span><span style="color: #000000;font-weight: bold">[</span><span style="background-color: #f8f8f8">from</span><span style="color: #000000;font-weight: bold">]</span> <span style="color: #000000;font-weight: bold">&lt;</span> <span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="background-color: #f8f8f8">wait</span> <span style="color: #000000;font-weight: bold">....</span>
  <span style="color: #000000;font-weight: bold">}</span>
  <span style="background-color: #f8f8f8">transfer</span> <span style="background-color: #f8f8f8">funds</span> <span style="color: #000000;font-weight: bold">...</span>
<span style="color: #000000;font-weight: bold">}</span> <span style="color: #000000;font-weight: bold">finally</span> <span style="color: #000000;font-weight: bold">{</span>
  <span style="background-color: #f8f8f8">bankLock</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">unlock</span><span style="color: #000000;font-weight: bold">();</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre></div></div>
<div class="paragraph fragment"><p>We have acquired <code>bankLock</code> and are waiting for someone to top up the account. But no one will ever be able to do it, because <code>bankLock</code> is locked by us.</p></div></div></section>
<section id="_condition_objects"><h2>Condition Objects</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #000000;font-weight: bold">private</span> <span style="color: #445588;font-weight: bold">ReentrantLock</span> <span style="background-color: #f8f8f8">bankLock</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">ReentrantLock</span><span style="color: #000000;font-weight: bold">();</span>
<span style="color: #000000;font-weight: bold">private</span> <span style="color: #445588;font-weight: bold">Condition</span> <span style="background-color: #f8f8f8">sufficientFunds</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">bankLock</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">newCondition</span><span style="color: #000000;font-weight: bold">();</span>

<span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">moneyTransfer</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">from</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">to</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
  <span style="background-color: #f8f8f8">bankLock</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">lock</span><span style="color: #000000;font-weight: bold">();</span>
  <span style="color: #000000;font-weight: bold">try</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="color: #000000;font-weight: bold">while</span> <span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">accounts</span><span style="color: #000000;font-weight: bold">[</span><span style="background-color: #f8f8f8">from</span><span style="color: #000000;font-weight: bold">]</span> <span style="color: #000000;font-weight: bold">&lt;</span> <span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">)</span>
      <span style="background-color: #f8f8f8">sufficientFunds</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">await</span><span style="color: #000000;font-weight: bold">();</span>

    <span style="background-color: #f8f8f8">accounts</span><span style="color: #000000;font-weight: bold">[</span><span style="background-color: #f8f8f8">from</span><span style="color: #000000;font-weight: bold">]-=</span><span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">;</span>
    <span style="background-color: #f8f8f8">accounts</span><span style="color: #000000;font-weight: bold">[</span><span style="background-color: #f8f8f8">to</span><span style="color: #000000;font-weight: bold">]+=</span><span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">;</span>

    <span style="background-color: #f8f8f8">sufficientFunds</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">signalAll</span><span style="color: #000000;font-weight: bold">();</span>
  <span style="color: #000000;font-weight: bold">}</span> <span style="color: #000000;font-weight: bold">finally</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="background-color: #f8f8f8">bankLock</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">unlock</span><span style="color: #000000;font-weight: bold">();</span>
  <span style="color: #000000;font-weight: bold">}</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre></div></div></div></section>
<section id="_condition_objects_what_happens"><h2>Condition Objects: What happens?</h2><div class="slide-content"><div class="ulist"><ul><li><p><code>await()</code> releases the lock and puts the thread into a waiting state,</p></li><li><p><code>signalAll()</code> signals to all waiting threads that something has changed,</p></li><li><p>exiting <code>await()</code> <em>acquires the lock again</em>.</p></li><li><p>When exiting <code>await()</code> we check the condition again because:</p><div class="ulist"><ul><li><p>the signal could be sent for another reason,</p></li><li><p>"spurious wakeups" are possible.</p></li></ul></div></li></ul></div></div></section>
<section id="_question"><h2>Question</h2><div class="slide-content"><div class="ulist"><ul><li><p>How is it guaranteed that when we leave <code>await()</code> we will see changes made by another thread?</p></li></ul></div>
<div class="ulist fragment"><ul><li><p>When exiting <code>await()</code> we capture the lock again, the JMM Monitor Lock Rule is working.</p></li></ul></div></div></section>
<section id="_correct_condition_waiting_pattern"><h2>Correct condition waiting pattern</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #000000;font-weight: bold">while</span> <span style="color: #000000;font-weight: bold">(!</span><span style="background-color: #f8f8f8">okToProceed</span><span style="color: #000000;font-weight: bold">())</span>
  <span style="background-color: #f8f8f8">condition</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">await</span><span style="color: #000000;font-weight: bold">();</span></code></pre></div></div></div></section>
<section id="_intrinsic_lock"><h2>Intrinsic lock</h2><div class="slide-content"><div class="ulist"><ul><li><p>Starting with Java 1.0, every object has an intrinsic lock.</p></li><li><p>Each intrinsic lock has one condition.</p></li></ul></div></div></section>
<section id="_same_with_intrinsic_lock"><h2>Same with intrinsic lock</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #999988;font-style: italic">//enter intrinsic lock on *this*</span>
<span style="color: #000000;font-weight: bold">synchronized</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">moneyTransfer</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">from</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">to</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="color: #000000;font-weight: bold">while</span> <span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">accounts</span><span style="color: #000000;font-weight: bold">[</span><span style="background-color: #f8f8f8">from</span><span style="color: #000000;font-weight: bold">]</span> <span style="color: #000000;font-weight: bold">&lt;</span> <span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">)</span>
      <span style="background-color: #f8f8f8">wait</span><span style="color: #000000;font-weight: bold">();</span> <span style="color: #999988;font-style: italic">//wait on intrinsic object's lock condition</span>

    <span style="background-color: #f8f8f8">accounts</span><span style="color: #000000;font-weight: bold">[</span><span style="background-color: #f8f8f8">from</span><span style="color: #000000;font-weight: bold">]-=</span><span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">;</span>
    <span style="background-color: #f8f8f8">accounts</span><span style="color: #000000;font-weight: bold">[</span><span style="background-color: #f8f8f8">to</span><span style="color: #000000;font-weight: bold">]+=</span><span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">;</span>

    <span style="background-color: #f8f8f8">notifyAll</span><span style="color: #000000;font-weight: bold">();</span> <span style="color: #999988;font-style: italic">//notify all threads waiting on the condition</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre></div></div></div></section>
<section id="_synchronized_block"><h2><code>synchronized</code> block</h2><div class="slide-content"><div class="paragraph"><p>Another form of using intrinsic locks:</p></div>
<div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #000000;font-weight: bold">private</span> <span style="color: #445588;font-weight: bold">Object</span> <span style="background-color: #f8f8f8">lock</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">Object</span><span style="color: #000000;font-weight: bold">();</span>
<span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">moneyTransfer</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">from</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">to</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
  <span style="color: #000000;font-weight: bold">synchronized</span> <span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">lock</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="color: #000000;font-weight: bold">while</span> <span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">accounts</span><span style="color: #000000;font-weight: bold">[</span><span style="background-color: #f8f8f8">from</span><span style="color: #000000;font-weight: bold">]</span> <span style="color: #000000;font-weight: bold">&lt;</span> <span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">)</span>
      <span style="background-color: #f8f8f8">lock</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">wait</span><span style="color: #000000;font-weight: bold">();</span>

    <span style="background-color: #f8f8f8">accounts</span><span style="color: #000000;font-weight: bold">[</span><span style="background-color: #f8f8f8">from</span><span style="color: #000000;font-weight: bold">]-=</span><span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">;</span>
    <span style="background-color: #f8f8f8">accounts</span><span style="color: #000000;font-weight: bold">[</span><span style="background-color: #f8f8f8">to</span><span style="color: #000000;font-weight: bold">]+=</span><span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">;</span>

    <span style="background-color: #f8f8f8">lock</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">notifyAll</span><span style="color: #000000;font-weight: bold">();</span>
  <span style="color: #000000;font-weight: bold">}</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre></div></div></div></section>
<section id="_intermediate_conclusions_for_intrinsic_conditions"><h2>Intermediate conclusions for intrinsic conditions</h2><div class="slide-content"><div class="ulist"><ul><li><p>It is necessary to follow the strict pattern:</p><div class="ulist"><ul><li><p>synchronization,</p></li><li><p>while-loop wait,</p></li><li><p>notification.</p></li></ul></div></li><li><p>You need to keep in mind:</p><div class="ulist"><ul><li><p>the object whose intrinsic lock we are capturing,</p></li><li><p>the object whose condition we use for waiting,</p></li><li><p>threads waiting on which condition we notify (it all should relate to the same object).</p></li></ul></div></li><li><p>In general, this is a low-level and complex mechanism. Its understanding will be useful during job interviews, but most likely, you will not need to use it.</p></li></ul></div></div></section>
<section id="_now_we_understand_the_meaning_of_all_the_possible_thread_states"><h2>Now we understand the meaning of all the possible thread states</h2><div class="slide-content"><div class="imageblock"><img src="images/threadstates.png.png" alt="threadstates"></div></div></section>
<section id="_intermediate_conclusions_for_all_of_the_above"><h2>Intermediate conclusions for all of the above</h2><div class="slide-content"><div class="ulist"><ul><li><p>Where possible, use immutable state: it is automatically thread-safe.</p></li><li><p>Use volatile variables or synchronization to access mutable state.</p></li><li><p>Hold the lock while performing operations that should be atomic.</p></li><li><p>To reiterate: <strong>a program with a shared mutable state without proper synchronization is a broken program</strong>.</p></li><li><p>Think about thread safety all the time.</p></li><li><p>JMM understanding helps</p></li></ul></div></div></section>
<section id="_part_2_deadlocks"><h2>Part 2. Deadlocks</h2><div class="slide-content"><div class="imageblock"><img src="images/hydra2.jpg" alt="hydra2" width="90%"></div></div></section>
<section id="_deadlock_a_simple_example"><h2>Deadlock: A Simple Example</h2><div class="slide-content"><div class="imageblock"><img src="images/deadlock.png" alt="deadlock"></div></div></section>
<section id="_wrong_order_of_blocking"><h2>Wrong order of blocking</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #000000;font-weight: bold">class</span> <span style="color: #445588;font-weight: bold">LeftRightDeadlock</span> <span style="color: #000000;font-weight: bold">{</span>
  <span style="color: #000000;font-weight: bold">private</span> <span style="color: #000000;font-weight: bold">final</span> <span style="color: #445588;font-weight: bold">Object</span> <span style="background-color: #f8f8f8">left</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">Object</span><span style="color: #000000;font-weight: bold">();</span>
  <span style="color: #000000;font-weight: bold">private</span> <span style="color: #000000;font-weight: bold">final</span> <span style="color: #445588;font-weight: bold">Object</span> <span style="background-color: #f8f8f8">right</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">Object</span><span style="color: #000000;font-weight: bold">();</span>
  <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">leftRight</span><span style="color: #000000;font-weight: bold">()</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="color: #000000;font-weight: bold">synchronized</span> <span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">left</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
      <span style="color: #000000;font-weight: bold">synchronized</span> <span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">right</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
        <span style="background-color: #f8f8f8">doSomething</span><span style="color: #000000;font-weight: bold">();</span>
      <span style="color: #000000;font-weight: bold">}</span>
    <span style="color: #000000;font-weight: bold">}</span>
  <span style="color: #000000;font-weight: bold">}</span>
  <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">rightLeft</span><span style="color: #000000;font-weight: bold">()</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="color: #000000;font-weight: bold">synchronized</span> <span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">right</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
      <span style="color: #000000;font-weight: bold">synchronized</span> <span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">left</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
        <span style="background-color: #f8f8f8">doSomethingElse</span><span style="color: #000000;font-weight: bold">();</span>
      <span style="color: #000000;font-weight: bold">}</span>
    <span style="color: #000000;font-weight: bold">}</span>
  <span style="color: #000000;font-weight: bold">}</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre></div></div></div></section>
<section id="_sometimes_wrong_order_of_blocking"><h2>(Sometimes?) wrong order of blocking</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">transferMoney</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">Account</span> <span style="background-color: #f8f8f8">fromAccount</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #445588;font-weight: bold">Account</span> <span style="background-color: #f8f8f8">toAccount</span><span style="color: #000000;font-weight: bold">,</span>
                     <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">throws</span> <span style="color: #445588;font-weight: bold">InsufficientFundsException</span> <span style="color: #000000;font-weight: bold">{</span>
  <span style="color: #000000;font-weight: bold">synchronized</span> <span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">fromAccount</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="color: #000000;font-weight: bold">synchronized</span> <span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">toAccount</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
      <span style="color: #000000;font-weight: bold">if</span> <span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">fromAccount</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">getBalance</span><span style="color: #000000;font-weight: bold">()</span> <span style="color: #000000;font-weight: bold">&lt;</span> <span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">)</span>
        <span style="color: #000000;font-weight: bold">throw</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #990000;font-weight: bold">InsufficientFundsException</span><span style="color: #000000;font-weight: bold">();</span>
      <span style="color: #000000;font-weight: bold">else</span> <span style="color: #000000;font-weight: bold">{</span>
        <span style="background-color: #f8f8f8">fromAccount</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">debit</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">);</span>
        <span style="background-color: #f8f8f8">toAccount</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">credit</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">amount</span><span style="color: #000000;font-weight: bold">);</span>
      <span style="color: #000000;font-weight: bold">}</span>
    <span style="color: #000000;font-weight: bold">}</span>
  <span style="color: #000000;font-weight: bold">}</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre></div></div></div></section>
<section id="_conclusions"><h2>Conclusions</h2><div class="slide-content"><div class="ulist"><ul><li><p>If function captures more than one lock, deadlock is possible.</p></li><li><p>To avoid deadlocks, you need to make sure that the locks are always captured in the same order. Sometimes it&#8217;s not obvious how to do it.</p></li><li><p>If you have captured a lock&#8201;&#8212;&#8201;finish with it as quickly as possible, do not call external methods.</p></li></ul></div></div></section>
<section id="_part_3_thread_safe_data_structures"><h2>Part 3. Thread-safe data structures</h2><div class="slide-content"><div class="imageblock"><img src="images/hydra2.jpg" alt="hydra2" width="90%"></div></div></section>
<section id="_non_blocking_algorithms"><h2>Non-blocking algorithms</h2><div class="slide-content"><div class="ulist"><ul><li><p>Locking (via <code>synchronized</code> or <code>ReentrantLock</code>) solves the issue of coordinating the actions of different threads with a variable.</p></li><li><p>But if many threads compete for the lock (high lock contention), the cost of coordinating the threads becomes significant.</p></li><li><p>The alternative is <em>non-blocking algorithms</em> that use special atomic machine instructions (compare-and-swap).</p></li><li><p>In the Java library, <em>classes of atomic variables</em> and <em>thread-safe collections</em> are available, including those implementing non-blocking algorithms.</p></li></ul></div></div></section>
<section id="_atomics"><h2>Atomics</h2><div class="slide-content"><div class="ulist"><ul><li><p><code>package java.util.concurrent.atomic</code></p><div class="ulist"><ul><li><p><code>AtomicBoolean</code>, <code>AtomicInteger</code>, <code>AtomicLong</code>, <code>AtomicReference</code>.</p></li><li><p><code>AtomicIntegerArray</code>, <code>AtomicLongArray</code>, <code>AtomicReferenceArray</code>.</p></li></ul></div></li><li><p>Can be used as "enhanced volatiles", as the result of calling <code>set(&#8230;&#8203;)</code> is visible to other threads via <code>get(&#8230;&#8203;)</code></p></li><li><p>Support atomic operations.</p></li></ul></div></div></section>
<section id="_atomic_operations_in_atomic_variable_classes"><h2>Atomic operations in atomic variable classes</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="text">getAndSet(newValue)    compareAndSet(expect, update)

incrementAndGet()      decrementAndGet()

getAndIncrement()      getAndDecrement()

getAndAdd(delta)       addAndGet(delta)

getAndUpdate(updateFunction)
updateAndGet(updateFunction)

getAndAccumulate(x, accumulatorBiFunction)
accumulateAndGet(x, accumulatorBiFunction)</code></pre></div></div></div></section>
<section id="_thread_safe_collections"><h2>Thread-safe collections</h2><div class="slide-content"><div class="ulist"><ul><li><p>In earlier versions of Java, it was possible to "make" a collection thread-safe by wrapping it in <code>Collections.synchronizedXXX(&#8230;&#8203;)</code>. This serialized any access to the internal state of the collection. Because of backward compatibility support, doing this is still possible, but not recommended.</p></li><li><p>The price of such a solution is high lock contention.</p></li><li><p>Version 5 introduces classes specifically designed for thread safety, with fewer locks.</p></li><li><p>Their use is <em>preferred</em>.</p></li></ul></div></div></section></div></div><script src="reveal.js-3.9.2/js/reveal.js"></script><script>Array.prototype.slice.call(document.querySelectorAll('.slides section')).forEach(function(slide) {
  if (slide.getAttribute('data-background-color')) return;
  // user needs to explicitly say he wants CSS color to override otherwise we might break custom css or theme (#226)
  if (!(slide.classList.contains('canvas') || slide.classList.contains('background'))) return;
  var bgColor = getComputedStyle(slide).backgroundColor;
  if (bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
    slide.setAttribute('data-background-color', bgColor);
    slide.style.backgroundColor = 'transparent';
  }
});

// More info about config & dependencies:
// - https://github.com/hakimel/reveal.js#configuration
// - https://github.com/hakimel/reveal.js#dependencies
Reveal.initialize({
  // Display presentation control arrows
  controls: true,
  // Help the user learn the controls by providing hints, for example by
  // bouncing the down arrow when they first encounter a vertical slide
  controlsTutorial: true,
  // Determines where controls appear, "edges" or "bottom-right"
  controlsLayout: 'bottom-right',
  // Visibility rule for backwards navigation arrows; "faded", "hidden"
  // or "visible"
  controlsBackArrows: 'faded',
  // Display a presentation progress bar
  progress: true,
  // Display the page number of the current slide
  slideNumber: true,
  // Control which views the slide number displays on
  showSlideNumber: 'all',
  // Add the current slide number to the URL hash so that reloading the
  // page/copying the URL will return you to the same slide
  hash: false,
  // Push each slide change to the browser history. Implies `hash: true`
  history: true,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Disables the default reveal.js slide layout so that you can use custom CSS layout
  disableLayout: false,
  // Vertical centering of slides
  center: false,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // See https://github.com/hakimel/reveal.js/#navigation-mode
  navigationMode: 'default',
  // Randomizes the order of slides each time the presentation loads
  shuffle: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags whether to include the current fragment in the URL,
  // so that reloading brings you to the same fragment position
  fragmentInURL: false,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Flags if we should show a help overlay when the questionmark
  // key is pressed
  help: true,
  // Flags if speaker notes should be visible to all viewers
  showNotes: false,
  // Global override for autolaying embedded media (video/audio/iframe)
  // - null: Media will only autoplay if data-autoplay is present
  // - true: All media will autoplay, regardless of individual setting
  // - false: No media will autoplay, regardless of individual setting
  autoPlayMedia: null,
  // Global override for preloading lazy-loaded iframes
  // - null: Iframes with data-src AND data-preload will be loaded when within
  //   the viewDistance, iframes with only data-src will be loaded when visible
  // - true: All iframes with data-src will be loaded when within the viewDistance
  // - false: All iframes with data-src will be loaded only when visible
  preloadIframes: null,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Use this method for navigation when auto-sliding
  autoSlideMethod: Reveal.navigateNext,
  // Specify the average time in seconds that you think you will spend
  // presenting each slide. This is used to show a pacing timer in the
  // speaker view
  defaultTiming: 120,
  // Specify the total time in seconds that is available to
  // present.  If this is set to a nonzero value, the pacing
  // timer will work out the time available for each slide,
  // instead of using the defaultTiming value
  totalTime: 0,
  // Specify the minimum amount of time you want to allot to
  // each slide, if using the totalTime calculation method.  If
  // the automated time allocation causes slide pacing to fall
  // below this threshold, then you will see an alert in the
  // speaker notes window
  minimumTimePerSlide: 0,
  // Enable slide navigation via mouse wheel
  mouseWheel: true,
  // Hide cursor if inactive
  hideInactiveCursor: true,
  // Time before the cursor is hidden (in ms)
  hideCursorTime: 5000,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  // Add `data-preview-link` and `data-preview-link="false"` to customise each link
  // individually
  previewLinks: false,
  // Transition style (e.g., none, fade, slide, convex, concave, zoom)
  transition: 'none',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., none, fade, slide, convex, concave, zoom)
  backgroundTransition: 'fade',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Number of slides away from the current that are visible on mobile
  // devices. It is advisable to set this to a lower number than
  // viewDistance in order to save resources.
  mobileViewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',
  // Number of pixels to move the parallax background per slide
  // - Calculated automatically unless specified
  // - Set to 0 to disable movement along an axis
  parallaxBackgroundHorizontal: null,
  parallaxBackgroundVertical: null,
  // The display mode that will be used to show slides
  display: 'block',

  // The "normal" size of the presentation, aspect ratio will be preserved
  // when the presentation is scaled to fit different resolutions. Can be
  // specified using percentage units.
  width: 1600,
  height: 900,

  // Factor of the display size that should remain empty around the content
  margin: 0.1,

  // Bounds for smallest/largest possible scale to apply to content
  minScale: 0.2,
  maxScale: 1.5,

  // PDF Export Options
  // Put each fragment on a separate page
  pdfSeparateFragments: true,
  // For slides that do not fit on a page, max number of pages
  pdfMaxPagesPerSlide: 1,

  // Optional libraries used to extend on reveal.js
  dependencies: [
      { src: 'reveal.js-3.9.2/plugin/zoom-js/zoom.js', async: true },
      { src: 'reveal.js-3.9.2/plugin/notes/notes.js', async: true }
  ],

  

});</script><script>var dom = {};
dom.slides = document.querySelector('.reveal .slides');

function getRemainingHeight(element, slideElement, height) {
  height = height || 0;
  if (element) {
    var newHeight, oldHeight = element.style.height;
    // Change the .stretch element height to 0 in order find the height of all
    // the other elements
    element.style.height = '0px';
    // In Overview mode, the parent (.slide) height is set of 700px.
    // Restore it temporarily to its natural height.
    slideElement.style.height = 'auto';
    newHeight = height - slideElement.offsetHeight;
    // Restore the old height, just in case
    element.style.height = oldHeight + 'px';
    // Clear the parent (.slide) height. .removeProperty works in IE9+
    slideElement.style.removeProperty('height');
    return newHeight;
  }
  return height;
}

function layoutSlideContents(width, height) {
  // Handle sizing of elements with the 'stretch' class
  toArray(dom.slides.querySelectorAll('section .stretch')).forEach(function (element) {
    // Determine how much vertical space we can use
    var limit = 5; // hard limit
    var parent = element.parentNode;
    while (parent.nodeName !== 'SECTION' && limit > 0) {
      parent = parent.parentNode;
      limit--;
    }
    if (limit === 0) {
      // unable to find parent, aborting!
      return;
    }
    var remainingHeight = getRemainingHeight(element, parent, height);
    // Consider the aspect ratio of media elements
    if (/(img|video)/gi.test(element.nodeName)) {
      var nw = element.naturalWidth || element.videoWidth, nh = element.naturalHeight || element.videoHeight;
      var es = Math.min(width / nw, remainingHeight / nh);
      element.style.width = (nw * es) + 'px';
      element.style.height = (nh * es) + 'px';
    } else {
      element.style.width = width + 'px';
      element.style.height = remainingHeight + 'px';
    }
  });
}

function toArray(o) {
  return Array.prototype.slice.call(o);
}

Reveal.addEventListener('slidechanged', function () {
  layoutSlideContents(1600, 900)
});
Reveal.addEventListener('ready', function () {
  layoutSlideContents(1600, 900)
});
Reveal.addEventListener('resize', function () {
  layoutSlideContents(1600, 900)
});</script></body></html>